<!DOCTYPE html>
<html lang="ar">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>الإعلانات | Smart Lab</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        body {
            font-family: sans-serif;
            background: #0f0f0f;
            color: #eee;
        }

        .container {
            max-width: 1000px;
            margin: 80px auto;
            padding: 20px;
        }

        .ad-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border: 1px solid #333;
            margin-bottom: 10px;
        }

        .ad-btn {
            background: #00bcd4;
            color: #000;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer
        }

        .ad-btn[disabled] {
            opacity: 0.5;
            cursor: not-allowed
        }

        #top-banner-ad,
        #bottom-banner-ad {
            position: fixed;
            left: 0;
            width: 100%;
            text-align: center;
            z-index: 10000
        }

        #top-banner-ad {
            top: 0
        }

        #bottom-banner-ad {
            bottom: 0
        }

        .ad-counters {
            text-align: center;
            margin-top: 12px
        }
    </style>
</head>

<body>
    <div id="top-banner-ad">
        <!-- provider banner (kept as-is) -->
        <script type='text/javascript'
            src='//pl27202122.revenuecpmgate.com/24/3e/ee/243eee94c6a0fa1cf865b310d6ade1eb.js'></script>
    </div>

    <div class="container">
        <h1>صفحة الإعلانات (نظام معتمد)</h1>
        <p>اضغط على "مشاهدة الإعلان" لفتح الإعلان في نافذة جديدة. يجب إبقاء النافذة مفتوحة لمدة 30 ثانية ليتم اعتماد
            المشاهدة.</p>

        <div class="ad-item">
            <div>
                <strong>Ad 1</strong>
                <div style="font-size:13px;color:#bbb">نوع: popunder</div>
            </div>
            <div>
                <button id="ad1_btn" class="ad-btn">مشاهدة الإعلان</button>
                <div style="font-size:13px;margin-top:6px">نقرات: <span id="clicks_ad1">0</span>/25</div>
            </div>
        </div>

        <div class="ad-item">
            <div>
                <strong>Ad 2</strong>
                <div style="font-size:13px;color:#bbb">نوع: popunder</div>
            </div>
            <div>
                <button id="ad2_btn" class="ad-btn">مشاهدة الإعلان</button>
                <div style="font-size:13px;margin-top:6px">نقرات: <span id="clicks_ad2">0</span>/25</div>
            </div>
        </div>

        <div class="ad-counters">
            <small>تنبيه: إذا تم حظر النافذة المنبثقة، سيظهر رسالة لتعطيل مانع الإعلانات.</small>
        </div>
    </div>

    <div id="bottom-banner-ad">
        <script async="async" data-cfasync="false"
            src="//honorablegiven.com/07a0ea3dee3fc93775251a64a297df45/invoke.js"></script>
        <div id="container-07a0ea3dee3fc93775251a64a297df45"></div>
    </div>

    <script>
        const adsConfig = {
            'ad1': { apiType: 'ad1', counterId: 'clicks_ad1', max: 25 },
            'ad2': { apiType: 'ad2', counterId: 'clicks_ad2', max: 25 }
        };

        // initialize counters from localStorage
        Object.keys(adsConfig).forEach(k => {
            const cfg = adsConfig[k];
            const val = parseInt(localStorage.getItem(cfg.counterId) || '0');
            document.getElementById(cfg.counterId).innerText = val;
        });

        function openCenteredPopup(url) {
            const screenW = window.screen.width;
            const screenH = window.screen.height;
            const w = Math.max(900, Math.floor(screenW * 0.8));
            const h = Math.max(600, Math.floor(screenH * 0.8));
            const left = Math.max(0, Math.floor((screenW - w) / 2));
            const top = Math.max(0, Math.floor((screenH - h) / 2));
            const features = `toolbar=0,location=0,status=0,menubar=0,scrollbars=1,resizable=1,width=${w},height=${h},left=${left},top=${top}`;
            return window.open(url, '_blank', features);
        }

        async function startAdFlow(adKey) {
            const cfg = adsConfig[adKey];
            let clicks = parseInt(localStorage.getItem(cfg.counterId) || '0');
            if (clicks >= cfg.max) { alert('لقد وصلت إلى الحد الأقصى لهذا الإعلان اليوم.'); return; }

            // request server to create token and return player URL
            let startResp;
            try {
                startResp = await fetch('/api/start_ad_view', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ad_type: cfg.apiType }) });
            } catch (e) {
                console.error('start_ad_view request failed', e);
                alert('خطأ في الاتصال بالخادم. حاول مرة أخرى.');
                return;
            }
            const startData = await startResp.json();
            if (!startResp.ok) { alert(startData.error || 'خطأ في بدء الإعلان'); return; }

            const playerUrl = startData.player_url;
            const token = startData.token;

            const btn = document.getElementById(adKey + '_btn');
            const origText = btn.innerText;
            btn.disabled = true;

            const popup = openCenteredPopup(playerUrl);
            if (!popup) {
                btn.disabled = false;
                alert('تعذر فتح الإعلان. يرجى تعطيل مانع الإعلانات أو السماح بالنوافذ المنبثقة.');
                return;
            }

            let seconds = 30;
            btn.innerText = `جارٍ المشاهدة... (${seconds})`;

            const checkClosed = setInterval(() => {
                if (!popup || popup.closed) {
                    clearInterval(checkClosed);
                    btn.disabled = false;
                    btn.innerText = origText;
                    alert('تم إغلاق الإعلان قبل اكتمال المشاهدة. لم يتم احتساب الرصيد.');
                }
            }, 500);

            const tick = setInterval(async () => {
                seconds--;
                btn.innerText = `جارٍ المشاهدة... (${seconds})`;
                if (seconds <= 0) {
                    clearInterval(tick);
                    clearInterval(checkClosed);
                    try {
                        // confirm with server
                        const confResp = await fetch('/api/confirm_ad_view', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ token }) });
                        const confData = await confResp.json();
                        if (!confResp.ok) { throw new Error(confData.error || 'confirm failed'); }

                        // success: update local counters and UI
                        clicks = clicks + 1;
                        localStorage.setItem(cfg.counterId, clicks);
                        document.getElementById(cfg.counterId).innerText = clicks;
                        if (confData.new_balance) {
                            const balEl = document.getElementById('balance');
                            if (balEl) balEl.innerText = Number(confData.new_balance).toFixed(6);
                        }
                        alert('تم تحديث رصيدك بنجاح!');
                    } catch (err) {
                        console.error('confirm_ad_view error', err);
                        alert('حدث خطأ أثناء تأكيد المشاهدة.');
                    } finally {
                        try { if (popup && !popup.closed) popup.close(); } catch (e) { }
                        btn.disabled = false;
                        btn.innerText = origText;
                    }
                }
            }, 1000);
        }

        document.getElementById('ad1_btn').addEventListener('click', () => startAdFlow('ad1'));
        document.getElementById('ad2_btn').addEventListener('click', () => startAdFlow('ad2'));
    </script>
</body>

</html>