{% extends "base.html" %}

{% block content %}
<div class="dashboard-container">
    <h2>Dashboard</h2>
    <div class="balance-info">
        Your current balance: <span class="balance-amount">{{ "%.3f"|format(balance) }} USD</span>
    </div>

    <div class="ad-section">
        <h3>Earn by Clicking Ads</h3>
        <div class="ad-buttons">
            <div class="ad-button-group">
                <button class="btn ad-btn" id="ad1">Click for Popunder Ad 1</button>
                <p>Clicks today: <span id="clicks_ad1">{{ clicks_ad1 }}</span> / {{ ad_limit_per_button }}</p>
            </div>
            <div class="ad-button-group">
                <button class="btn ad-btn" id="ad2">Click for Popunder Ad 2</button>
                <p>Clicks today: <span id="clicks_ad2">{{ clicks_ad2 }}</span> / {{ ad_limit_per_button }}</p>
            </div>
        </div>
        <p class="total-clicks">Total clicks today: {{ total_clicks_today }} / {{ ad_total_limit }}</p>
    </div>

    <!-- Modal for Ad Viewing -->
    <div id="ad-modal" class="ad-modal" style="display:none;">
        <div class="ad-modal-content">
            <span id="ad-modal-close" class="ad-modal-close">&times;</span>
            <h3>Watch the Ad</h3>
            <div id="ad-modal-script"></div>
            <div id="ad-timer">40</div>
            <div id="ad-modal-message"></div>
        </div>
    </div>

    <div class="referral-section">
        <h3>Refer a Friend</h3>
        <p>Share your referral link to earn commission when your referrals withdraw:</p>
        <input type="text" value="{{ referral_link }}" readonly class="referral-link-input">
        <button class="btn copy-btn" onclick="copyReferralLink()">Copy Link</button>
    </div>

    <div class="withdrawal-section">
        <h3>Withdraw Funds</h3>
        <p>Minimum withdrawal amount: 0.5 USD</p>
        <a href="{{ url_for('withdraw') }}" class="btn withdraw-btn">Withdraw</a>
    </div>
</div>

<script type='text/javascript'>
    function showAdModal(adType, scriptUrl) {
        const clicksAd1 = parseInt(document.getElementById('clicks_ad1').innerText);
        const clicksAd2 = parseInt(document.getElementById('clicks_ad2').innerText);
        const totalClicksToday = clicksAd1 + clicksAd2;
        const adLimitPerButton = parseInt("{{ ad_limit_per_button }}");
        const adTotalLimit = parseInt("{{ ad_total_limit }}");

        if (totalClicksToday >= adTotalLimit) {
            alert('You have reached your daily ad click limit ({{ ad_total_limit }} total).');
            return;
        }
        if (adType === 'popunder1' && clicksAd1 >= adLimitPerButton) {
            alert('You have reached the daily limit for Popunder Ad 1 ({{ ad_limit_per_button }} clicks).');
            return;
        } else if (adType === 'popunder2' && clicksAd2 >= adLimitPerButton) {
            alert('You have reached the daily limit for Popunder Ad 2 ({{ ad_limit_per_button }} clicks).');
            return;
        }

        // Show modal
        const modal = document.getElementById('ad-modal');
        const modalScript = document.getElementById('ad-modal-script');
        const modalTimer = document.getElementById('ad-timer');
        const modalMsg = document.getElementById('ad-modal-message');
        modal.style.display = 'block';
        modalScript.innerHTML = '';
        modalMsg.innerHTML = '';

        // Load ad script inside modal
        const script = document.createElement("script");
        script.src = scriptUrl;
        script.async = true;
        modalScript.appendChild(script);

        let seconds = 40;
        modalTimer.innerText = seconds;
        let timer = setInterval(() => {
            seconds--;
            modalTimer.innerText = seconds;
            if (seconds <= 0) {
                clearInterval(timer);
                // After timer, call backend to add balance
                fetch("/api/add_balance", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ ad_type: adType })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.error) {
                            modalMsg.innerHTML = `<span style='color:red;'>Error: ${data.error}</span>`;
                        } else {
                            modalMsg.innerHTML = `<span style='color:green;'>Balance updated: ${data.new_balance.toFixed(3)} USD</span>`;
                            document.querySelector('.balance-amount').innerText = data.new_balance.toFixed(3) + ' USD';
                            if (adType === 'popunder1') {
                                document.getElementById('clicks_ad1').innerText = clicksAd1 + 1;
                            } else if (adType === 'popunder2') {
                                document.getElementById('clicks_ad2').innerText = clicksAd2 + 1;
                            }
                            document.querySelector('.total-clicks').innerText = `Total clicks today: ${totalClicksToday + 1} / ${adTotalLimit}`;
                        }
                    })
                    .catch(err => {
                        modalMsg.innerHTML = `<span style='color:red;'>Error updating balance.</span>`;
                    });
            }
        }, 1000);

        // Close modal logic
        document.getElementById('ad-modal-close').onclick = function () {
            modal.style.display = 'none';
            clearInterval(timer);
        };
    }

    document.getElementById("ad1").addEventListener("click", () => {
        showAdModal("popunder1", "//pl27588635.revenuecpmgate.com/e4/06/54/e40654054912ec87321f8ae7b5b8475e.js");
    });
    document.getElementById("ad2").addEventListener("click", () => {
        showAdModal("popunder2", "//pl27623329.revenuecpmgate.com/3f/1b/ae/3f1bae06be8fb8243633dd02aa28465b.js");
    });
</script>
{% block head %}
<style>
    .ad-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .ad-modal-content {
        background: #222;
        padding: 30px 20px;
        border-radius: 10px;
        box-shadow: 0 0 20px #00ffff;
        text-align: center;
        min-width: 320px;
        max-width: 90vw;
        position: relative;
    }

    .ad-modal-close {
        position: absolute;
        top: 10px;
        right: 20px;
        font-size: 2em;
        color: #fff;
        cursor: pointer;
    }

    #ad-timer {
        font-size: 2em;
        margin: 15px 0;
        color: #ffd700;
        font-weight: bold;
    }

    #ad-modal-message {
        margin-top: 10px;
        font-size: 1.1em;
    }
</style>
{% endblock %}